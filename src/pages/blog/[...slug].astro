---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const canonicalUrl = `https://valery.omlab.club/blog/${post.id}/`;
const isoDate = post.data.date.toISOString();

function formatDate(date) {
  return date.toLocaleDateString('ru-RU', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

const jsonLd = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.description,
  datePublished: isoDate,
  author: {
    '@type': 'Person',
    name: 'Валерия Ом',
    url: 'https://valery.omlab.club',
  },
});
---

<BaseLayout title={`${post.data.title} — Валерия Ом`} description={post.data.description}>
  <Fragment slot="head">
    <meta property="og:title" content={post.data.title} />
    <meta property="og:description" content={post.data.description} />
    <meta property="og:type" content="article" />
    <link rel="canonical" href={canonicalUrl} />
    <script type="application/ld+json" set:html={jsonLd} />
  </Fragment>

  <main class="flex-1 relative">

    <div class="grain"></div>

    <article class="max-w-[720px] mx-auto px-6 pt-20 pb-24 md:pt-32 md:pb-32">
      <!-- Back -->
      <a href="/blog/" class="fade-in inline-flex items-center gap-2 font-body text-sm text-[var(--accent)] opacity-60 hover:opacity-100 transition-opacity duration-300 mb-8">
        &larr; Блог
      </a>

      <!-- Header -->
      <header class="fade-in mb-12">
        <h1 class="font-display text-3xl sm:text-4xl md:text-5xl leading-[1.12] mb-4">
          {post.data.title}
        </h1>

        <time class="block font-body text-sm text-[var(--text)] opacity-30 mb-4">
          {formatDate(post.data.date)}
        </time>

        {post.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map((tag) => (
              <span class="inline-block font-mono text-[11px] text-[var(--accent)] border border-[var(--accent)] opacity-50 rounded-[20px] px-3 py-0.5">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      <!-- Divider -->
      <div class="h-px bg-[var(--accent)] opacity-10 mb-12"></div>

      <!-- Content -->
      <div class="fade-in prose">
        <Content />
      </div>

      <!-- Bottom divider -->
      <div class="h-px bg-[var(--accent)] opacity-10 mt-16 mb-8"></div>

      <!-- Footer -->
      <div class="fade-in flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <a href="/blog/" class="font-body text-sm text-[var(--accent)] opacity-60 hover:opacity-100 transition-opacity duration-300">
          &larr; Все записи
        </a>
        <a
          href="/consultation/"
          class="inline-flex items-center px-5 py-2.5 text-sm font-body font-medium rounded-[6px] bg-[var(--accent)] text-[#1A2E1A] hover:bg-[var(--accent-light)] transition-colors duration-300"
        >
          Консультация&ensp;&rarr;
        </a>
      </div>
    </article>

  </main>
</BaseLayout>

<style>
  .grain {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 50;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px 256px;
  }

  .prose {
    font-family: 'DM Sans', sans-serif;
    font-size: 1.125rem;
    line-height: 1.7;
    color: var(--text);
  }

  .prose :global(p) {
    margin-bottom: 1.25em;
    opacity: 0.65;
  }

  .prose :global(h2) {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    line-height: 1.3;
    margin-top: 2.5em;
    margin-bottom: 0.75em;
    opacity: 1;
  }

  .prose :global(h3) {
    font-family: 'Playfair Display', serif;
    font-size: 1.25rem;
    line-height: 1.3;
    margin-top: 2em;
    margin-bottom: 0.5em;
    opacity: 1;
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-color: rgba(200, 164, 78, 0.3);
    transition: text-decoration-color 0.3s;
  }
  .prose :global(a:hover) {
    text-decoration-color: var(--accent);
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--accent);
    padding-left: 20px;
    margin: 1.5em 0;
    font-style: italic;
    opacity: 0.6;
  }
  .prose :global(blockquote p) {
    margin-bottom: 0;
    opacity: 1;
  }

  .prose :global(code) {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875em;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 6px;
  }

  .prose :global(pre) {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25em;
    overflow-x: auto;
    margin: 1.5em 0;
  }
  .prose :global(pre code) {
    background: none;
    border: none;
    padding: 0;
  }

  .prose :global(hr) {
    border: none;
    height: 1px;
    background: var(--accent);
    opacity: 0.1;
    margin: 2.5em 0;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1.25em;
    padding-left: 1.5em;
    opacity: 0.65;
  }
  .prose :global(li) {
    margin-bottom: 0.5em;
  }

  .prose :global(strong) {
    opacity: 1;
  }

  .fade-in {
    opacity: 0;
    transform: translateY(24px);
    transition: opacity 0.7s ease-out, transform 0.7s ease-out;
  }
  .fade-in.visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  function initFadeIn() {
    const els = document.querySelectorAll('.fade-in');
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
    );
    els.forEach((el) => observer.observe(el));
  }

  initFadeIn();
  document.addEventListener('astro:after-swap', initFadeIn);
</script>
